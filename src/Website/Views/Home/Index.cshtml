@using TilosPlayer.Library.Domain
@model IEnumerable<Episode>

@{
    ViewData["Title"] = "TilosPlayer";
    string controlsIfInQueryString = Context.Request.Query["controls"].Any() ? "controls" : string.Empty;
    var huCulture = new System.Globalization.CultureInfo("hu-HU");
    var controlIds = new
    {
        ProgressBar = "progressbar"
    };
    
}

<nav class="navbar fixed-top navbar-light bg-light">
    <div class="container">
        <a class="navbar-brand" href="#">
            <img src="~/images/tilos-logo-header.jpg" style="border-radius:15%;width:30px" class="d-inline-block align-top" alt="">
            TilosPlayer
        </a>
        <form class="form-inline">
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text" id="basic-addon1"><i class="far fa-calendar-alt"></i></span>
                </div>
                <input id="datePicker" class="form-control " type="text" placeholder="Dátum" aria-label="Dátum">
            </div>

            <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
        </form>
    </div>
</nav>


<div class="container">
    <style>
        .card img
        {
            width:100%;
        }

        .card-header:hover i
        {
            color: green;
        }
    </style>

    @{
        Episode previousEpisode = null;
    }
    @foreach (var episode in Model)
    {
        if (previousEpisode == null || episode.RealFrom.Date != previousEpisode.RealFrom.Date)
        {
            <div class="row alert-info shadow mb-5 bg-info rounded" style="padding-top:30px; margin-bottom:15px" >
                <div class="hidden-xs col-md-2">@* filler *@</div>
                <div class="col-xs-5 col-md-3">
                </div>
                <div class="col-xs-7 col-md-5">
                    <h5 class="display-4">@episode.RealFrom.ToString("dddd", huCulture)</h5>
                </div>
                <div class="hidden-xs col-md-2">@* filler *@</div>
            </div>
        }
        previousEpisode = episode;


        <div class="row" style="overflow:hidden" id="episode-@episode.Id">

            <div class="hidden-xs col-md-1">@* filler *@</div>
            <div class="col-xs-5 col-md-4 text-right">
                <div class="alert alert-primary" role="alert">
                    <h3>@episode.RealFrom.ToString("HH:mm")</h3>
                </div>
                <h6>@episode.RealFrom.ToString("MMMM dd.", huCulture)</h6>
            </div>
            <div class="col-xs-7 col-md-7">


                <div class="card bg-light shadow mb-5 rounded" style="margin-bottom:30px">
                    <h3 class="card-header" onclick="onShowClicked('@episode.Id')" style="cursor: pointer">
                        @episode.Show.Name
                        <i><span class="text-muted">[@episode.RealTo.Subtract(episode.RealFrom).ToString(@"hh\:mm")]</span></i>
                        <i class="fas fa-play-circle"></i>
                    </h3>
                    <div class="card-body">
                        <h5 class="card-title">
                            @episode.Text?.Title
                        </h5>
                        <h6 class="card-subtitle mb-2 text-muted">
 
                                @Html.Raw(episode.Show.Definition)


                        </h6>

                        <div class="card-text " style="margin-top:20px;overflow:hidden">
                                @Html.Raw(episode.Text?.Formatted)
                        </div>
                    </div>
                    <div class="card-footer text-muted">
                        <span class="">
                            @if (episode.Show.Type == "MUSIC")
                            {
                                <i class="fas fa-music"></i>
                            }
                            else if (episode.Show.Type == "SPEECH")
                            {
                                <i class="far fa-comments"></i>
                            }
                        </span>
                        @episode.FormattedAgo
                        @*<i class="fas fa-circle" style="font-size:6px;padding-left:4px;padding-right:4px"></i>*@
                        <a href="@episode.MediaUrl" class="badge badge-light"><i class="fas fa-link"></i> mp3</a>
                        @*<i class="fas fa-circle" style="font-size:6px;padding-left:4px;padding-right:4px"></i>*@
                        <a href="@episode.MediaUrl" class="badge badge-light"><i class="fas fa-link"></i> tilos.hu</a>

                    </div>
                </div>



            </div>
            <div class="hidden-xs hidden-md"></div>
        </div>
    }
</div>

@section Footer {
<h1>
    <i id="playButton" class="fas fa-play-circle" onclick="onPlayClicked()"></i>
    <i id="pauseButton" class="fas fa-pause-circle" onclick="onPauseClicked()"></i>
    <i class="fas fa-forward"></i>
    <i class="fas fa-backward"></i>
    <div style="display:inline-block;width:42px;cursor:pointer">
        <google-cast-launcher style="--disconnected-color: white;vertical-align:middle">
        </google-cast-launcher>
    </div>
    <div id="currentShowName"></div>
</h1>
    @*<div id="statusMessage">.....</div>*@
    <div id="progressContainer" class="progress" style="height:6px;cursor:pointer">
        <div id="@controlIds.ProgressBar" class="progress-bar" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width:0"></div>
    </div>
}

@section Scripts {
    <script>

        $(document).ready(function () {
            $("#datePicker").datepicker({
                weekStart: 1,
                maxViewMode: 2,
                todayBtn: true,
                language: "hu",
                todayHighlight: true,
                autoclose: true,
                startDate: "2010.01.01",
                endDate: "2029.01.01",
                format: "yyyy-mm-dd",
            }).on("changeDate", function (e) {
                var url = window.location.protocol + "//" + window.location.hostname + (window.location.port.length > 0 ? (":" + window.location.port) : "") + "/Home/Index/" + e.date.toISOString().substring(0, 10);
                console.log(e);
                console.log(url);

                //window.location = url;
            });
        });
        
        function onProgressBarClicked(e) {
            console.log("-------");
            var container = document.getElementById("progressContainer");
            var l = container.getBoundingClientRect().left;
            var r = container.getBoundingClientRect().right;
            var w = r - l;
            console.log(e);
            console.log(l);
            var pos = e.clientX - l;
            console.log(pos);
            var p = (pos / w) * 100;
            tilosPlayer.seekToPercent(p);
            console.log(p);
        }

        function onShowClicked(episodeId) {
            var episode = episodes.filter(e => e.id == episodeId)[0];
            console.log(episode);
            tilosPlayer.currentEpisode = episode;
            tilosPlayer.refresh();
        }



        var episodes = @Json.Serialize(Model);
        var controlIds = @Json.Serialize(controlIds);

        tilosPlayer = new TilosPlayer();
        $("#progressContainer").on("click", tilosPlayer.onProgBar);
        window['__onGCastApiAvailable'] = tilosPlayer.initializeCastApi;

        function onPauseClicked() {
            tilosPlayer.pause();
        }

        function onPlayClicked() {
            tilosPlayer.play();
        }
    </script>
    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>


}